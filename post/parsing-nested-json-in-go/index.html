<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Parsing Deeply Nested JSON in Go</title>
  <meta property="og:title" content="Parsing Deeply Nested JSON in Go" />
  <meta name="twitter:title" content="Parsing Deeply Nested JSON in Go" />
  <meta name="description" content="Challenges parsing nested json in Go">
  <meta property="og:description" content="Challenges parsing nested json in Go">
  <meta name="twitter:description" content="Challenges parsing nested json in Go">
  <meta name="author" content="Ricardo Aravena"/>
  <link href='https://raravena80.github.io/img/favicon.png' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="https://raravena80.github.io/img/avatar-icon.png" />
  <meta name="twitter:image" content="https://raravena80.github.io/img/avatar-icon.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@raravena80" />
  <meta name="twitter:creator" content="@raravena80" />
  <meta property="og:url" content="https://raravena80.github.io/post/parsing-nested-json-in-go/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Rico&#39;s Blog" />

  <meta name="generator" content="Hugo 0.37.1" />
  <link rel="canonical" href="https://raravena80.github.io/post/parsing-nested-json-in-go/" />
  <link rel="alternate" href="https://raravena80.github.io/index.xml" type="application/rss+xml" title="Rico&#39;s Blog">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://raravena80.github.io/css/main.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="https://raravena80.github.io/css/pygment_highlights.css" />
  <link rel="stylesheet" href="https://raravena80.github.io/css/highlight.min.css" />
</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://raravena80.github.io/">Rico&#39;s Blog</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="Rico&#39;s Blog" href="https://raravena80.github.io/">
            <img class="avatar-img" src="https://raravena80.github.io/img/avatar-icon.png" alt="Rico&#39;s Blog" />
          </a>
        
      </div>
    </div>

  </div>
</nav>




    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>Parsing Deeply Nested JSON in Go</h1>
                
                
                  <span class="post-meta">
  Posted on April 28, 2017
  
</span>


                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>Parsing deeply nested json in Go is a bit challenging due to the fact that the language doesn&rsquo;t provide many helpers to do so. If you do that in Ruby or Python it&rsquo;s pretty straight forward running some like this in Python <code>j = json.load(jsonstring)</code> or in Ruby <code>j = JSON.load(jsonstring)</code>.</p>

<p>In go generally you have to prefine your structs and run through an <code>Unmarshal</code> function which means that most of the times you need to know ahead of time what the nest level and structure of your target json is to parse it. For example:</p>

<p><a href="https://play.golang.org/p/Q4IHjBVSfY">https://play.golang.org/p/Q4IHjBVSfY</a></p>

<pre><code class="language-go">package main

import (
	&quot;encoding/json&quot;
	&quot;fmt&quot;
	&quot;log&quot;
)

var data = []byte(`
    {
        &quot;client&quot;: {
                &quot;id&quot;: &quot;2212fw&quot;,
                &quot;name&quot;: &quot;Papupapa Hernandez&quot;,
                &quot;email&quot;: &quot;papupapa@gmail.com&quot;,
                &quot;phones&quot;: [&quot;554-223-2311&quot;, &quot;332-232-2123&quot;]
        }
    }
`)

type Client struct {
	Id     string   `json:&quot;id&quot;`
	Name   string   `json:&quot;name&quot;`
	Email  string   `json:&quot;email&quot;`
	Phones []string `json:&quot;phones&quot;`
}

type Info struct {
	Key Client `json:&quot;client&quot;`
}

func main() {

	var info Info
	if err := json.Unmarshal(data, &amp;info); err != nil {
		log.Fatal(err)
	}
	fmt.Printf(&quot;%+v\n&quot;, info)

}
</code></pre>

<p>When you have deeply nested JSON this becomes a pain in the butt. Enter <a href="https://github.com/tidwall/gjson">gjson</a>, with this library thanks to <a href="https://github.com/tidwall">@tidwall</a> we can parse n-level nested JSON that has hashes and arrays. This came in handy when parsing for example the following JSON:</p>

<p><a name="jsonparse"></a></p>

<pre><code class="language-json">{
    &quot;i$tems&quot;: {
        &quot;it$em&quot;: [
            {
                &quot;batt$ers&quot;: {
                    &quot;ba$tter&quot;: [
                        {
                            &quot;i$d&quot;: &quot;1001&quot;,
                            &quot;t$ype&quot;: &quot;Regular&quot;
                        },
                        {
                            &quot;i$d&quot;: &quot;1002&quot;,
                            &quot;type&quot;: &quot;Chocolate&quot;
                        },
                        {
                            &quot;i$d&quot;: &quot;1003&quot;,
                            &quot;t$ype&quot;: &quot;Blueberry&quot;
                        },
                        {
                            &quot;i$d&quot;: &quot;1004&quot;,
                            &quot;t$ype&quot;: &quot;Devil's Food&quot;
                        }
                    ]
                },
                &quot;$id&quot;: &quot;0001&quot;,
                &quot;$name&quot;: &quot;Cake&quot;,
                &quot;$ppu&quot;: 0.55,
                &quot;$topping&quot;: [
                    {
                        &quot;i$d&quot;: &quot;5001&quot;,
                        &quot;t$ype&quot;: &quot;None&quot;
                    },
                    {
                        &quot;i$d&quot;: &quot;5002&quot;,
                        &quot;t$ype&quot;: &quot;Glazed&quot;
                    },
                    {
                        &quot;i$d&quot;: &quot;5005&quot;,
                        &quot;t$ype&quot;: &quot;Sugar&quot;
                    },
                    {
                        &quot;i$d&quot;: &quot;5007&quot;,
                        &quot;t$ype&quot;: &quot;Powdered Sugar&quot;
                    },
                    {
                        &quot;i$d&quot;: &quot;5006&quot;,
                        &quot;t$ype&quot;: &quot;Chocolate with Sprinkles&quot;
                    },
                    {
                        &quot;i$d&quot;: &quot;5003&quot;,
                        &quot;t$ype&quot;: &quot;Chocolate&quot;
                    },
                    {
                        &quot;i$d&quot;: &quot;5004&quot;,
                        &quot;t$ype&quot;: &quot;Maple&quot;
                    }
                ],
                &quot;ty$pe&quot;: &quot;donut&quot;
            }
        ]
    }
}
</code></pre>

<p>You can have something like this:</p>

<pre><code class="language-go">package main

import (
        &quot;encoding/json&quot;
        &quot;fmt&quot;
        &quot;github.com/tidwall/gjson&quot;
        &quot;io/ioutil&quot;
        &quot;os&quot;
)

func main() {

        file, e := ioutil.ReadFile(&quot;./nested.json&quot;)
        if e != nil {
                fmt.Printf(&quot;File error: %v\n&quot;, e)
                os.Exit(1)
        }
        myJson := string(file)
        m, ok := gjson.Parse(myJson).Value().(map[string]interface{})
        if !ok {
                fmt.Println(&quot;Error&quot;)
        }

        jsonBytes, err := json.Marshal(m)
        if err != nil {
                fmt.Println(err)
        }
        fmt.Println(string(jsonBytes))
}
</code></pre>

<p>So the <a href="https://github.com/tidwall/gjson">gjson</a> library allows you to Marshall to a bunch of empty interface{} types (at compile type) that at run time the basically become the &lsquo;maps&rsquo; and &lsquo;slices&rsquo; in a JSON structure.</p>

<p>Running the above code outputs:</p>

<pre><code class="language-json">{&quot;i$tems&quot;:{&quot;it$em&quot;:[{&quot;$id&quot;:&quot;0001&quot;,&quot;$name&quot;:&quot;Cake&quot;,&quot;$ppu&quot;:0.55,&quot;$topping&quot;:[{&quot;i$d&quot;:&quot;5001&quot;,&quot;t$ype&quot;:&quot;None&quot;},{&quot;i$d&quot;:&quot;5002&quot;,&quot;t$ype&quot;:&quot;Glazed&quot;},{&quot;i$d&quot;:&quot;5005&quot;,&quot;t$ype&quot;:&quot;Sugar&quot;},{&quot;i$d&quot;:&quot;5007&quot;,&quot;t$ype&quot;:&quot;Powdered Sugar&quot;},{&quot;i$d&quot;:&quot;5006&quot;,&quot;t$ype&quot;:&quot;Chocolate with Sprinkles&quot;},{&quot;i$d&quot;:&quot;5003&quot;,&quot;t$ype&quot;:&quot;Chocolate&quot;},{&quot;i$d&quot;:&quot;5004&quot;,&quot;t$ype&quot;:&quot;Maple&quot;}],&quot;batt$ers&quot;:{&quot;ba$tter&quot;:[{&quot;i$d&quot;:&quot;1001&quot;,&quot;t$ype&quot;:&quot;Regular&quot;},{&quot;i$d&quot;:&quot;1002&quot;,&quot;type&quot;:&quot;Chocolate&quot;},{&quot;i$d&quot;:&quot;1003&quot;,&quot;t$ype&quot;:&quot;Blueberry&quot;},{&quot;i$d&quot;:&quot;1004&quot;,&quot;t$ype&quot;:&quot;Devil's Food&quot;}]},&quot;ty$pe&quot;:&quot;donut&quot;}]}}
</code></pre>

<p>The issue now is how to access all these structures recursively. Enter the <a href="https://golang.org/pkg/reflect/">reflect</a> package in Go. This package allows you to do things similar to in Ruby like <code>variable.is_a?(Hash)</code> or <code>variable.is_a?(Array)</code></p>

<p>To solve the original problem with the <a href="#jsonparse">JSON</a> above I had to write a little bit of code. So the problem is remove the <code>$</code> character from all the keys in the nested JSON structure. So now I have:</p>

<pre><code class="language-go">package main

import (
        &quot;encoding/json&quot;
        &quot;fmt&quot;
        &quot;github.com/tidwall/gjson&quot;
        &quot;io/ioutil&quot;
        &quot;os&quot;
        &quot;reflect&quot;
        &quot;regexp&quot;
        &quot;strings&quot;
)

func iterate(data interface{}) interface{} {

        if reflect.ValueOf(data).Kind() == reflect.Slice {
                d := reflect.ValueOf(data)
                tmpData := make([]interface{}, d.Len())
                returnSlice := make([]interface{}, d.Len())
                for i := 0; i &lt; d.Len(); i++ {
                        tmpData[i] = d.Index(i).Interface()
                }
                for i, v := range tmpData {
                        returnSlice[i] = iterate(v)
                }
                return returnSlice
        } else if reflect.ValueOf(data).Kind() == reflect.Map {
                d := reflect.ValueOf(data)
                tmpData := make(map[string]interface{})
                for _, k := range d.MapKeys() {
                        match, _ := regexp.MatchString(&quot;$&quot;, k.String())
                        typeOfValue := reflect.TypeOf(d.MapIndex(k).Interface()).Kind()
                        if match {
                                new_key := strings.Replace(k.String(), &quot;$&quot;, &quot;&quot;, -1)
                                if typeOfValue == reflect.Map || typeOfValue == reflect.Slice {
                                        tmpData[new_key] = iterate(d.MapIndex(k).Interface())
                                } else {
                                        tmpData[new_key] = d.MapIndex(k).Interface()
                                }
                        } else {
                                fmt.Println(&quot;debug&quot;)
                                if typeOfValue == reflect.Map || typeOfValue == reflect.Slice {
                                        tmpData[k.String()] = iterate(d.MapIndex(k).Interface())
                                } else {
                                        tmpData[k.String()] = d.MapIndex(k).Interface()
                                }
                        }
                }
                return tmpData
        }
        return data
}

func main() {

        file, e := ioutil.ReadFile(&quot;./nested.json&quot;)
        if e != nil {
                fmt.Printf(&quot;File error: %v\n&quot;, e)
                os.Exit(1)
        }
        myJson := string(file)
        m, ok := gjson.Parse(myJson).Value().(map[string]interface{})
        if !ok {
                fmt.Println(&quot;Error&quot;)
        }

        newM := iterate(m)
        jsonBytes, err := json.Marshal(newM)
        if err != nil {
                fmt.Println(err)
        }
        fmt.Println(string(jsonBytes))
}
</code></pre>

<p>which outputs (in prettified json):</p>

<pre><code>{
    &quot;items&quot;: {
        &quot;item&quot;: [
            {
                &quot;batters&quot;: {
                    &quot;batter&quot;: [
                        {
                            &quot;id&quot;: &quot;1001&quot;,
                            &quot;type&quot;: &quot;Regular&quot;
                        },
                        {
                            &quot;id&quot;: &quot;1002&quot;,
                            &quot;type&quot;: &quot;Chocolate&quot;
                        },
                        {
                            &quot;id&quot;: &quot;1003&quot;,
                            &quot;type&quot;: &quot;Blueberry&quot;
                        },
                        {
                            &quot;id&quot;: &quot;1004&quot;,
                            &quot;type&quot;: &quot;Devil's Food&quot;
                        }
                    ]
                },
                &quot;id&quot;: &quot;0001&quot;,
                &quot;name&quot;: &quot;Cake&quot;,
                &quot;ppu&quot;: 0.55,
                &quot;topping&quot;: [
                    {
                        &quot;id&quot;: &quot;5001&quot;,
                        &quot;type&quot;: &quot;None&quot;
                    },
                    {
                        &quot;id&quot;: &quot;5002&quot;,
                        &quot;type&quot;: &quot;Glazed&quot;
                    },
                    {
                        &quot;id&quot;: &quot;5005&quot;,
                        &quot;type&quot;: &quot;Sugar&quot;
                    },
                    {
                        &quot;id&quot;: &quot;5007&quot;,
                        &quot;type&quot;: &quot;Powdered Sugar&quot;
                    },
                    {
                        &quot;id&quot;: &quot;5006&quot;,
                        &quot;type&quot;: &quot;Chocolate with Sprinkles&quot;
                    },
                    {
                        &quot;id&quot;: &quot;5003&quot;,
                        &quot;type&quot;: &quot;Chocolate&quot;
                    },
                    {
                        &quot;id&quot;: &quot;5004&quot;,
                        &quot;type&quot;: &quot;Maple&quot;
                    }
                ],
                &quot;type&quot;: &quot;donut&quot;
            }
        ]
    }
}
</code></pre>

<p>So there we have it. We were able to parse nested JSON using <a href="https://github.com/tidwall/gjson">gjson</a> and then modify the keys for the structure so that none of them have the <code>$</code> sign.</p>

<p>Full code is available here: <a href="https://github.com/raravena80/carabobo/blob/master/jsonkeys/jsonkeys.go">https://github.com/raravena80/carabobo/blob/master/jsonkeys/jsonkeys.go</a></p>

      </article>

      <ul class="pager blog-pager">
        
          <li class="previous">
            <a href="https://raravena80.github.io/post/cloudnativecon-kubecon-europe/" data-toggle="tooltip" data-placement="top" title="CloudNativeCon KubeCon Europe">&larr; Previous Post</a>
          </li>
        
        
          <li class="next">
            <a href="https://raravena80.github.io/post/dcos-on-gcp/" data-toggle="tooltip" data-placement="top" title="DC/OS on GCP">Next Post &rarr;</a>
          </li>
        
      </ul>

      
        
          <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "raravena80" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
        
      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:raravena80@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://www.facebook.com/raravena80" title="Facebook">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://plus.google.com/&#43;RicardoAravenaV" title="Google&#43;">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-google-plus fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/raravena80" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/raravena80" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/raravena" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://stackoverflow.com/users/2989261/rico" title="StackOverflow">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-stack-overflow fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://www.instagram.com/raravena80" title="Instagram">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="https://raravena80.github.io/index.xml" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          Ricardo Aravena
          &nbsp;&bull;&nbsp;
          2018

          
            &nbsp;&bull;&nbsp;
            <a href="https://raravena80.github.io/">Rico&#39;s Blog</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          
          
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="https://raravena80.github.io/js/main.js"></script>
<script src="https://raravena80.github.io/js/highlight.min.js"></script>
<script> hljs.initHighlightingOnLoad(); </script>
<script> renderMathInElement(document.body); </script>







  </body>
</html>

